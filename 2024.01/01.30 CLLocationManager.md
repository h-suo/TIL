# Today I Learned ğŸ¤“

> 2024.01.30 (í™”)

## CLLocationManager

> ìœ„ì¹˜ ê´€ë ¨ ì´ë²¤íŠ¸ì˜ ì „ë‹¬ì„ ì‹œì‘í•˜ê³  ì¤‘ì§€í•˜ëŠ” ë° ì‚¬ìš©í•˜ëŠ” ê°ì²´
> 
> `iOS 2.0+` `iPadOS 2.0+` `macOS 10.6+`

```swift
class CLLocationManager : NSObject
```

### ì–¸ì œ ì‚¬ìš©í• ê¹Œ?

CLLocationManagerëŠ” ìœ„ì¹˜ ê´€ë ¨ ë™ì‘ì„ ê´€ë¦¬í•˜ëŠ” ê°ì²´ë¡œ, ì‚¬ìš©ìì˜ ìœ„ì¹˜ ë³€ê²½ì„ ì¶”ì , ë‚˜ì¹¨ë°˜ì˜ ë°©í–¥ ë³€ê²½ ë³´ê³ , ì§€ë¦¬ì  ì˜ì—­ ëª¨ë‹ˆí„°ë§, í•´ë‹¹ ì§€ì—­ë³„ ì´ë²¤íŠ¸ ìƒì„± ë“±ì˜ ë™ì‘ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©ë©ë‹ˆë‹¤.

CLLocationManager ê°ì²´ë¥¼ ìƒì„±í•˜ê³ , CLLocationManagerDelegate í”„ë¡œí† ì½œì„ ì¤€ìˆ˜í•˜ë„ë¡ locationManager(_:didUpdateLocations:)ë¥¼ êµ¬í˜„í•˜ì—¬ ìœ„ì¹˜ ì •ë³´ê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆì„ ë•Œ ìœ„ì¹˜ë¥¼ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
final class LocationViewController: UIViewController {
  private let loactionManager: CLLocationManager = CLLocationManager()
  // ...
}

extension LocationViewController: CLLocationManagerDelegate {
  
  private func setupLocationManager() {
    loactionManager.delegate = self
    loactionManager.desiredAccuracy = kCLLocationAccuracyBest
    loactionManager.requestWhenInUseAuthorization()
    loactionManager.startUpdatingLocation()
  }
  
  func locationManager(
    _ manager: CLLocationManager,
    didUpdateLocations locations: [CLLocation]
  ) {
    
    guard let location = locations.last else {
      return
    }
      
    print("Current location: lat\(location.coordinate.latitude), lon\(location.coordinate.longitude)")
  }
}
```

<br>

## CLLocationManager + Combine

ìœ„ì¹˜ ê´€ë ¨ ë™ì‘ì„ ê´€ë¦¬í•˜ëŠ” CLLocationManagerë¥¼ Combineê³¼ ê²°í•©í•˜ì—¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ë°›ì•„ì˜¤ëŠ” ì—­í• ì„ í•˜ëŠ” LocationManagerService ê°ì²´ë¥¼ ë§Œë“¤ì–´ ë³´ê² ìŠµë‹ˆë‹¤.

### ì–¸ì œ ì‚¬ìš©í• ê¹Œ?

ViewControllerì—ì„œ ìœ„ì¹˜ ì •ë³´ë¥¼ ì²˜ë¦¬í•˜ëŠ” ê²ƒì´ ì•„ë‹Œ ìœ„ì¹˜ ì •ë³´ë¥¼ ë°›ì•„ì˜¤ëŠ” ê°ì²´ë¥¼ ë”°ë¡œ ë§Œë“¤ê³  ì‹¶ê±°ë‚˜, SwiftUIë¥¼ ì‚¬ìš©í•  ë•Œ Viewì—ì„œ CLLocationManagerDelegateë¥¼ ì±„íƒí•  ìˆ˜ ì—†ì–´ ìœ„ì¹˜ ì •ë³´ë¥¼ ë°›ì•„ì˜¤ëŠ” ê°ì²´ê°€ í•„ìš”í•  ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

locationManager(_:didUpdateLocations:)ëŠ” ìœ„ì¹˜ ì •ë³´ë¥¼ ìš”ì²­í•˜ë©´ ë¹„ë™ê¸°ì ìœ¼ë¡œ í˜¸ì¶œë˜ê¸° ë•Œë¬¸ì— Combineì„ ì‚¬ìš©í•˜ì—¬ ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ í•´ì¤¬ìŠµë‹ˆë‹¤.

```swift
final class LocationManagerService: NSObject, CLLocationManagerDelegate {

  private var locationManager: CLLocationManager
  private var locationSubject = PassthroughSubject<CLLocationCoordinate2D, Error>()

  init(locationManager: CLLocationManager = CLLocationManager()) {
    self.locationManager = locationManager
    super.init()

    self.locationManager.delegate = self
    self.loactionManager.desiredAccuracy = kCLLocationAccuracyBest
    self.locationManager.requestWhenInUseAuthorization()
  }

  func requestLoactionPublisher() -> AnyPublisher<CLLocationCoordinate2D, Error> {
    locationManager.requestLocation()
    return locationSubject.eraseToAnyPublisher()
  }

  func locationManager(
    _ manager: CLLocationManager,
    didUpdateLocations locations: [CLLocation]
  ) {
    guard let location = locations.last?.coordinate
    else { return }

    locationSubject.send(location)
    locationManager.stopUpdatingLocation()
  }

  func locationManager(
    _ manager: CLLocationManager,
    didFailWithError error: Error
  ) {
    locationSubject.send(completion: .failure(error))
  }
}
```

requestLoactionPublisher()ë¥¼ í˜¸ì¶œí•˜ì—¬ ìœ„ì¹˜ ì •ë³´ë¥¼ ìš”ì²­í•˜ê³ , ìœ„ì¹˜ ë°ì´í„°ë¥¼ ë°›ê¸° ìœ„í•œ locationSubjectë¥¼ eraseToAnyPublisher í•œ AnyPublisher<CLLocationCoordinate2D, Error>ë¥¼ ë°›ì•„ì™€ êµ¬ë…í•©ë‹ˆë‹¤.

ì´í›„ locationManagerê°€ ìœ„ì¹˜ ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•˜ê±°ë‚˜ ì‹¤íŒ¨í–ˆì„ ë•Œ locationSubject sendë¥¼ ì´ìš©í•´ ìœ„ì¹˜ ë°ì´í„°ì™€ ì—ëŸ¬ë¥¼ ì „ì†¡í•˜ë©´ êµ¬ë…ìê°€ ì´ë¥¼ ë°›ì•„ ì²˜ë¦¬í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
let _ = LocationManagerService()
  .requestLoactionPublisher()
  .sink { completion in
    if case .failure(let error) = completion {
      print(error)
    }
  } receiveValue: { location in
    print(location)
  }
```

---
## ì°¸ê³  ë§í¬
- [Apple Developer: CLLocationManager](https://developer.apple.com/documentation/corelocation/cllocationmanager)
- [Apple Developer: CLLocationManagerDelegate](https://developer.apple.com/documentation/corelocation/cllocationmanagerdelegate)
