# Today I Learned ğŸ¤“

> 2024.01.19 (ê¸ˆ)

## SwiftUI + CoreData(2)

Project ì˜µì…˜ì„ SwiftUIì™€ Use CoreDataë¡œ ì„¤ì •í–ˆì„ ë•Œì˜ ì½”ë“œë¥¼ 2ê°œì˜ TILë¡œ ë‚˜ëˆ  ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

ë‘ ë²ˆì§¸ TILì—ì„œëŠ” ContentViewì— ëŒ€í•´ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

### ContentView

Use CoreDataë¥¼ ì„¤ì •í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ CoreDataê°€ ì—°ê²°ëœ ContentViewê°€ ìƒì„±ë©ë‹ˆë‹¤.

previewë¥¼ ì œì™¸í•œ ì½”ë“œë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

```swift
struct ContentView: View {
  @Environment(\.managedObjectContext) private var viewContext
  
  @FetchRequest(
    sortDescriptors: [NSSortDescriptor(keyPath: \Item.timestamp, ascending: true)],
    animation: .default)
  private var items: FetchedResults<Item>
  
  var body: some View { }
  
  private func addItem() { }
  
  private func deleteItems(offsets: IndexSet) { }
}

private let itemFormatter: DateFormatter 
```

#### viewContext

Environment í”„ë¡œí¼í‹° ë˜í¼ê°€ ëª…ì‹œí•˜ì—¬ ì™¸ë¶€ë¡œë¶€í„° ì£¼ì…ë°›ì€ NSManagedObjectContextì…ë‹ˆë‹¤.

```swift
@Environment(\.managedObjectContext) private var viewContext
```

#### items

FetchRequest í”„ë¡œí¼í‹° ë˜í¼ë¥¼ ì´ìš©í•´ CoreData Persistence Storeì—ì„œ Item ì—”í‹°í‹°ë¥¼ ê°€ì ¸ì˜¨ FetchedResultsì…ë‹ˆë‹¤.

```swift
@FetchRequest(
  sortDescriptors: [NSSortDescriptor(keyPath: \Item.timestamp, ascending: true)],
  animation: .default)
private var items: FetchedResults<Item>
```

#### body

bodyì—ëŠ” contentViewì˜ Viewê°€ ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

List í˜•íƒœë¡œ itemsë¥¼ í™”ë©´ì— í‘œì‹œí•˜ë©°, Toolbarì—ëŠ” ìƒˆë¡œìš´ itemì„ ì¶”ê°€í•˜ëŠ” addButtonê³¼ EditButtonì´ ìˆìŠµë‹ˆë‹¤. 

ë˜í•œ ìŠ¤ì™€ì´í”„ë‚˜ EditButtonì„ ì´ìš©í•´ itemì„ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
var body: some View {
  NavigationView {
    List {
      ForEach(items) { item in
        NavigationLink {
          Text("Item at \(item.timestamp!, formatter: itemFormatter)")
        } label: {
          Text(item.timestamp!, formatter: itemFormatter)
        }
      }
      .onDelete(perform: deleteItems)
    }
    .toolbar {
      ToolbarItem(placement: .navigationBarTrailing) {
        EditButton()
      }
      ToolbarItem {
        Button(action: addItem) {
          Label("Add Item", systemImage: "plus")
        }
      }
    }
    Text("Select an item")
  }
}
```
    
#### addItem

viewContextì— ìƒˆë¡œìš´ Itemì„ ë§Œë“¤ì–´ timestampë¥¼ í˜„ì¬ ì‹œê°„ìœ¼ë¡œ ì„¤ì •í•˜ê³  save()ë¥¼ í†µí•´ ì €ì¥í•˜ëŠ” ì‘ì—…ì„ í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.

```swift
private func addItem() {
  withAnimation {
    let newItem = Item(context: viewContext)
    newItem.timestamp = Date()
    
    do {
      try viewContext.save()
    } catch {
      let nsError = error as NSError
      fatalError("Unresolved error \(nsError), \(nsError.userInfo)")
    }
  }
}
```

#### deleteItems

ë°›ì•„ì˜¨ IndexSetì— í•´ë‹¹í•˜ëŠ” itemì„ viewContextì—ì„œ ì‚­ì œí•˜ê³  save()ë¥¼ í†µí•´ ë³€ê²½ì‚¬í•­ì„ ì €ì¥í•˜ëŠ” ì‘ì—…ì„ í•˜ëŠ” í•¨ìˆ˜ì…ë‹ˆë‹¤.

```swift
private func deleteItems(offsets: IndexSet) {
  withAnimation {
    offsets.map { items[$0] }.forEach(viewContext.delete)
    
    do {
      try viewContext.save()
    } catch {
      let nsError = error as NSError
      fatalError("Unresolved error \(nsError), \(nsError.userInfo)")
    }
  }
}
```

#### itemFormatter

itemì˜ timestampë¥¼ ì‚¬ìš©ìê°€ ë³´ê¸° í¸í•˜ë„ë¡ í¬ë§·í•˜ê¸° ìœ„í•œ DateFormatterì…ë‹ˆë‹¤.

```swift
private let itemFormatter: DateFormatter = {
  let formatter = DateFormatter()
  formatter.dateStyle = .short
  formatter.timeStyle = .medium
  return formatter
}()
```

---
## ì°¸ê³  ë§í¬
- [Apple Developer: Environment](https://developer.apple.com/documentation/swiftui/environment)
- [Apple Developer: FetchRequest](https://developer.apple.com/documentation/swiftui/fetchrequest)
