# Today I Learned ğŸ¤“

> 2024.01.23 (í™”)

## dataTaskPublisher(for:)

> ì£¼ì–´ì§„ URLì— ëŒ€í•œ URLSession dataTaskë¥¼ ë˜í•‘í•˜ëŠ” publisherë¥¼ ë°˜í™˜í•˜ëŠ” í•¨ìˆ˜
> 
> `iOS 13.0+` `iPadOS 13.0+` `macOS 10.15+`

```swift
func dataTaskPublisher(for url: URL) -> URLSession.DataTaskPublisher
```

### ì–¸ì œ ì‚¬ìš©í• ê¹Œ?

dataTask(with:completionHandler:)ë¥¼ ì‚¬ìš©í•˜ì—¬ escaping closureë¥¼ êµ¬í˜„í•˜ëŠ” ë°©ì‹ì˜ ë¹„ë™ê¸° ì²˜ë¦¬ê°€ ì•„ë‹Œ, Combineì„ ì´ìš©í•œ ë„¤íŠ¸ì›Œí‚¹ ë¹„ë™ê¸° ì²˜ë¦¬ë¥¼ í•  ë•Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Combineì„ ì´ìš©í•˜ì—¬ ë„¤íŠ¸ì›Œí‚¹ì„ í•œë‹¤ë©´ í•¨ìˆ˜í˜• í”„ë¡œê·¸ë˜ë°ìœ¼ë¡œ ì„ ì–¸ì  ì²˜ë¦¬ê°€ ê°€ëŠ¥í•˜ë©°, streamì„ ì´ìš©í•œ ë°˜ì‘í˜• UI ì²˜ë¦¬ê°€ ìš©ì´í•˜ë‹¤ëŠ” ì¥ì ì´ ìˆìŠµë‹ˆë‹¤.

<br>

### Networking With Escaping Closure

dataTask(with:completionHandler:)ë¥¼ ì´ìš©í•œ NetworkManagerì…ë‹ˆë‹¤.

requestData í•¨ìˆ˜ëŠ” urlSession dataTaskì˜ escaping closureë¥¼ êµ¬í˜„í•˜ì—¬ ë„¤íŠ¸ì›Œí‚¹ì´ ì™„ë£Œë˜ì—ˆì„ ë•Œ ì—ëŸ¬ ë° ì‘ë‹µì„ í™•ì¸í•˜ê³  completionì„ ì„±ê³µê³¼ ì‹¤íŒ¨ë¡œ ë‚˜ëˆ  ì•Œë§ê²Œ í˜¸ì¶œí•©ë‹ˆë‹¤.

```swift
struct NetworkManager {
    private let urlSession: URLSession
    
    init(urlSession: URLSession = URLSession.shared) {
        self.urlSession = urlSession
    }
    
    func requestData(from url: URL, completion: @escaping (Result<Data, NetworkError>) -> Void) {
        let task = urlSession.dataTask(with: url) { data, response, error in
            if let error {
                completion(.failure(.unknown(error)))
                return
            }
            
            guard let response = response as? HTTPURLResponse else {
                completion(.failure(.invalidResponse))
                return
            }
            guard (200..<300).contains(response.statusCode) else {
                completion(.failure(.responseFailed))
                return
            }
            
            guard let data else {
                completion(.failure(.emptyData))
                return
            }
            
            completion(.success(data))
        }
        
        task.resume()
    }
}
```

NetworkManagerë¥¼ ì´ìš©í•´ ë„¤íŠ¸ì›Œí‚¹ì„ ìˆ˜í–‰í•  ë•Œë„ escaping closureë¥¼ êµ¬í˜„í•˜ì—¬ ì„±ê³µí–ˆì„ ë•ŒëŠ” dataë¥¼ ë””ì½”ë”©í•˜ì—¬ ì‚¬ìš©í•˜ê³ , ì‹¤íŒ¨í–ˆì„ ë•ŒëŠ” ì—ëŸ¬ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
let url = URL(string: "https://api.testURL.org")!

NetworkManager().requestData(from: url) { result in
    switch result {
    case .success(let data):
        do {
            let dto = try JSONDecoder().decode(DTO.self, from: data)
            print(dto)
        } catch {
            print(error)
        }
    case .failure(let error):
        print(error.localizedDescription)
    }
}
```

### Networking With Combine

dataTaskPublisher(for:)ë¥¼ ì´ìš©í•œ NetworkManagerì…ë‹ˆë‹¤.

requestData í•¨ìˆ˜ëŠ” urlSession dataTaskPublisherë¡œ ë°›ì•„ì˜¨ URLSession.DataTaskPublisherë¥¼ AnyPublisher<Data, NetworkError>ë¡œ ë°˜í™˜í•´ ì£¼ê¸° ìœ„í•´ ë§¤í•‘ì„ í•©ë‹ˆë‹¤.

tryMapì„ ì´ìš©í•˜ì—¬ ì‘ë‹µì„ í™•ì¸í•˜ì—¬ ì—ëŸ¬ ì²˜ë¦¬ë¥¼ í•˜ê³  dataë¥¼ ë°˜í™˜í•´ ì¤ë‹ˆë‹¤. ê·¸ë¦¬ê³  mapErrorë¡œ ì—ëŸ¬ë¥¼ ë§¤í•‘í•´ì£¼ê³ , eraseToAnyPublisherë¡œ ë˜í•‘ ëœ Publisherë¥¼ ëª¨ë‘ ì§€ìš°ê³  AnyPublisherë¡œ Dataì™€ NetworkErrorë¥¼ ë˜í•‘í•˜ì—¬ ë°˜í™˜í•©ë‹ˆë‹¤.

```swift
struct NetworkManager {
    private let urlSession: URLSession
    
    init(urlSession: URLSession = URLSession.shared) {
        self.urlSession = urlSession
    }
    
    func requestData(from url: URL) -> AnyPublisher<Data, NetworkError> {
        return urlSession.dataTaskPublisher(for: url)
            .tryMap { data, response in
                guard let httpResponse = response as? HTTPURLResponse else {
                    throw NetworkError.invalidResponse
                }
                
                guard let response = response as? HTTPURLResponse,
                      (200..<300).contains(response.statusCode) else {
                    throw NetworkError.responseFailed
                }
                
                return data
            }
            .mapError { error in
                if let networkError = error as? NetworkError {
                    return networkError
                } else {
                    return .unknown(error)
                }
            }
            .eraseToAnyPublisher()
    }
}
```

NetworkManagerë¥¼ ì´ìš©í•´ ë„¤íŠ¸ì›Œí‚¹ì„ ìˆ˜í–‰í•  ë•ŒëŠ” requestDataë¡œ ë°›ì•„ì˜¨ AnyPublisherë¥¼ decodeë¥¼ ì´ìš©í•´ dataë¥¼ ë””ì½”ë”©í•˜ê±°ë‚˜ êµ¬ë…í•˜ì—¬ ì—ëŸ¬ ì²˜ë¦¬ ë° ë°ì´í„° ì²˜ë¦¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.

```swift
let url = URL(string: "https://api.testURL.org")!

let subscription = NetworkingWithCombine()
    .requestData(from: url)
    .decode(type: DTO.self, decoder: JSONDecoder())
    .sink { completion in
        if case .failure(let error) = completion {
            print(error.localizedDescription)
        }
    } receiveValue: { dto in
        print(dto)
    }
```

---
## ì°¸ê³  ë§í¬
- [Apple Developer: dataTaskPublisher(for:)Environment](https://developer.apple.com/documentation/foundation/urlsession/3329708-datataskpublisher)
- [Apple Developer: dataTask(with:completionHandler:)](https://developer.apple.com/documentation/foundation/urlsession/1407613-datatask)
- [Apple Developer: eraseToAnyPublisher()](https://developer.apple.com/documentation/combine/just/erasetoanypublisher())
