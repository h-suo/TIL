# Today I Learned ğŸ¤“

> 2024.02.20 (í™”)

## TCA Testing

TCAì—ì„œ êµ¬ì¶•ëœ ê¸°ëŠ¥ì˜ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥ì„±ì€ ì¤‘ìš”í•©ë‹ˆë‹¤. ì‘ì—…ì´ ì €ì¥ì†Œë¡œ ì „ì†¡ë  ë•Œ ìƒíƒœê°€ ì–´ë–»ê²Œ ë³€í•˜ëŠ”ì§€ë¿ë§Œ ì•„ë‹ˆë¼ íš¨ê³¼ê°€ ì–´ë–»ê²Œ ì‹¤í–‰ë˜ê³  ë°ì´í„°ë¥¼ ì‹œìŠ¤í…œì— ë‹¤ì‹œ ê³µê¸‰í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

í•˜ì—¬ ì•ì„œ [TCA, Getting started](https://github.com/h-suo/TIL/blob/main/2024.02/02.19%20TCA,%20Getting%20started.md)ì˜ ì˜ˆì‹œ ì½”ë“œ Featureì˜ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

### í…ŒìŠ¤íŠ¸ ì½”ë“œ

êµ¬í˜„ëœ ê¸°ëŠ¥ì˜ ê°€ì¥ ê°„ë‹¨í•œ í…ŒìŠ¤íŠ¸ëŠ” ìƒíƒœ ë³€ê²½ì„ í•´ë³´ëŠ” ê²ƒì…ë‹ˆë‹¤.

ì¼ë°˜ì ìœ¼ë¡œ featureì˜ reduceë¥¼ í˜¸ì¶œí•˜ì—¬ currentStateì˜ ìƒíƒœë¥¼ ë°”ê¾¸ëŠ” ê²ƒìœ¼ë¡œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
final class TCAExampleProjectTests: XCTestCase {
  
  func testBasics() {
    let feature = Feature()
    var currentState = Feature.State(count: 0)
    
    _ = feature.reduce(into: &currentState, action: .incrementButtonTapped)
    XCTAssertEqual(
      currentState,
      Feature.State(count: 1)
    )
    
    _ = feature.reduce(into: &currentState, action: .decrementButtonTapped)
    XCTAssertEqual(
      currentState,
      Feature.State(count: 0)
    )
  }
}
```

**TestStore**

í•˜ì§€ë§Œ TCAì—ì„œëŠ” ë” ê°„ë‹¨í•˜ê³  ê°„ê²°í•˜ê²Œ í…ŒìŠ¤íŠ¸í•˜ê¸° ìœ„í•œ TestStoreê°€ ì œê³µë©ë‹ˆë‹¤. ê¸°ëŠ¥ì˜ ì´ˆê¸° ìƒíƒœì™€ ê¸°ëŠ¥ì˜ ë¡œì§ì„ ì‹¤í–‰í•˜ëŠ” Reducerë¥¼ ì œê³µí•¨ìœ¼ë¡œì¨ ìŠ¤í† ì–´ì™€ ìœ ì‚¬í•˜ê²Œ ë™ì‘í•©ë‹ˆë‹¤.

```swift
@MainActor
final class TCAExampleProjectTests: XCTestCase {
    
  func testFeature() async {
    let store = TestStore(initialState: Feature.State()) {
      Feature()
    }
  }
}
```

TestStoreë¥¼ ì‚¬ìš©í•˜ì—¬ Actionì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Featureì—ì„œëŠ” ìƒíƒœë¥¼ ë°”ê¿€ ìˆ˜ ìˆëŠ” incrementButtonTapped, decrementButtonTappedì˜ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìœ¼ë©° Stateì˜ countì— ì˜ˆì¸¡ê°’ì„ ë„£ëŠ” ê²ƒìœ¼ë¡œ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
await store.send(.incrementButtonTapped) {
  $0.count = 1
}

await store.send(.decrementButtonTapped) {
  $0.count = 0
}
```

<br>

ë˜í•œ numberFactButtonTappedì„ í†µí•´ API Requestë¡œ ë°›ì•„ì˜¨ ë°ì´í„°ë¡œ ë³€ê²½ëœ numberFactResponseì˜ í…ŒìŠ¤íŠ¸ë„ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
await store.send(.numberFactButtonTapped)

await store.receive(\.numberFactResponse) {
  $0.numberFact = ???
}
```

í•˜ì§€ë§Œ API Requestì˜ ì‘ë‹µì„ ëª¨ë‘ ë„£ëŠ” ê²ƒì€ ì–´ë µê¸° ë•Œë¬¸ì— ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°í•˜ì§€ ì•Šê³  í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê¸° ìœ„í•œ ëª¨ì˜ ì¢…ì†ì„±ì„ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ê¸°ì¡´ Featureì— let numberFact: (Int) async throws -> Stringë¥¼ ì¶”ê°€í•˜ì—¬ numberFactButtonTapped Actionì— ëŒ€í•œ ë¡œì§ìœ¼ë¡œ numberFactë¥¼ í˜¸ì¶œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
@Reducer
struct Feature {
  let numberFact: (Int) async throws -> String
  
  @ObservableState
  struct State: Equatable { /* ... */ }
  enum Action { /* ... */ }
  
  var body: some Reducer<State, Action> {
    Reduce { state, action in
      switch action {
      // ...
      case .numberFactButtonTapped:
        return .run { [count = state.count] send in
          let fact = try await self.numberFact(count)
          await send(.numberFactResponse(fact))
        }
      }
    }
  }
}
```

Appì—ì„œ ì‹¤ì œ API ì„œë²„ì™€ ìƒí˜¸ ì‘ìš©í•˜ëŠ” ì¢…ì†ì„± ë¡œì§ì„ ì œê³µí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
@main
struct MyApp: App {
  var body: some Scene {
    WindowGroup {
      FeatureView(
        store: Store(initialState: Feature.State()) {
          Feature(
            numberFact: { number in
              let (data, _) = try await URLSession.shared.data(
                from: URL(string: "http://numbersapi.com/\(number)")!
              )
              return String(decoding: data, as: UTF8.self)
            }
          )
        }
      )
    }
  }
}
```

ì˜ˆì¸¡ ê°€ëŠ¥í•œ factë¥¼ ë°˜í™˜í•˜ëŠ” ëª¨ì˜ ì˜ì¡´ì„±ì„ ì‚¬ìš©í•˜ì—¬ í…ŒìŠ¤íŠ¸ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
@MainActor
func testFeature() async {
  let store = TestStore(initialState: Feature.State()) {
    Feature(numberFact: { "\($0) is a good number Brent" })
  }
}
```

```swift
await store.send(.numberFactButtonTapped)

await store.receive(\.numberFactResponse) {
  $0.numberFact = "0 is a good number Brent"
}
```

**DependencyKey**

numberFactë¡œ API Requestì— ëŒ€í•œ ì¢…ì†ì„±ì„ ì£¼ì…ë°›ì•„ ì‚¬ìš©í–ˆì§€ë§Œ, Reducerë¥¼ êµ¬ì„±í•  ë•Œ ì¢…ì†ì„± ë¡œì§ì„ ëª…ì‹œí•˜ëŠ” ê²ƒì€ ì¢‹ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì—¬ TCAì—ì„œ ì œê³µí•˜ëŠ” DependencyKeyë¥¼ í™œìš©í•˜ì—¬ ì¢…ì†ì„±ì„ ë“±ë¡í•˜ê³  ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

NumberFactë¥¼ íƒ€ì…ìœ¼ë¡œ ë§Œë“¤ì–´ DependencyKeyë¥¼ ì ìš©í•˜ì—¬ ë¼ì´ë¸Œ ê°’ì„ ì§€ì •í•˜ëŠ” ê²ƒìœ¼ë¡œ ì¢…ì†ì„± ë“±ë¡ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
struct NumberFactClient {
  var fetch: (Int) async throws -> String
}

extension NumberFactClient: DependencyKey {
  static let liveValue = Self(
    fetch: { number in
      let (data, _) = try await URLSession.shared
        .data(from: URL(string: "http://numbersapi.com/\(number)")!
      )
      return String(decoding: data, as: UTF8.self)
    }
  )
}


extension DependencyValues {
  var numberFact: NumberFactClient {
    get { self[NumberFactClient.self] }
    set { self[NumberFactClient.self] = newValue }
  }
}
```

ì¢…ì†ì„± ë“±ë¡ì´ ëë‚˜ë©´ @Dependency ì†ì„± ë˜í¼ë¥¼ ì‚¬ìš©í•˜ì—¬ ëª¨ë“  ê¸°ëŠ¥ì—ì„œ ì¢…ì†ì„±ì„ ì¦‰ì‹œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
@Reducer
struct Feature {
  @Dependency(\.numberFact) var numberFact
   
  @ObservableState
  struct State: Equatable { /* ... */ }
  enum Action { /* ... */ }
  
  var body: some Reducer<State, Action> {
    Reduce { state, action in
      switch action {
      // ...
      case .numberFactButtonTapped:
        return .run { [count = state.count] send in
          let fact = try await self.numberFact.fetch(count)
          await send(.numberFactResponse(fact))
        }
      }
    }
  }
}
```

ë˜í•œ Reducerë¥¼ ë“±ë¡í•  ë•Œ ì¢…ì†ì„±ì„ ëª…ì‹œì ìœ¼ë¡œ ì „ë‹¬í•  í•„ìš”ê°€ ì—†ìŠµë‹ˆë‹¤.

```swift
@main
struct MyApp: App {
  var body: some Scene {
    WindowGroup {
      FeatureView(
        store: Store(initialState: Feature.State()) {
          Feature()
        }
      )
    }
  }
}
```

í…ŒìŠ¤íŠ¸ ì‹œì—ëŠ” withDependenciesë¥¼ ì •ì˜í•˜ë©´ ì¢…ì†ì„±ì„ ë¬´ì‹œí•˜ê³  ì¢…ì†ì„±ì„ ì§€ì •í•´ ì¤„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
let store = TestStore(initialState: Feature.State()) {
  Feature()
} withDependencies: {
  $0.numberFact.fetch = { "\($0) is a good number Brent" }
}
```

---
## ì°¸ê³  ë§í¬
- [GitHub: swift Composable Architecture](https://github.com/pointfreeco/swift-composable-architecture)
- [Composable Architecture Documentation: Getting started](https://pointfreeco.github.io/swift-composable-architecture/main/documentation/composablearchitecture/gettingstarted)
- [Composable Architecture Documentation: Testing](https://pointfreeco.github.io/swift-composable-architecture/main/documentation/composablearchitecture/testing/)
