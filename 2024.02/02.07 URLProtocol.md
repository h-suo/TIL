# Today I Learned ğŸ¤“

> 2024.02.07 (ìˆ˜)

## URLProtocol

> í†µì‹  Protocolì— ë§ëŠ” URL ë°ì´í„°ì˜ ë¡œë”©ì„ ì²˜ë¦¬í•˜ëŠ” ì¶”ìƒ í´ë˜ìŠ¤
> 
> `iOS 2.0+` `iPadOS 2.0+` `macOS 10.2+`

```swift
class URLProtocol : NSObject
```

### ì–¸ì œ ì‚¬ìš©í• ê¹Œ?

í†µì‹  Protocolì— ë§ëŠ” URL ë°ì´í„° ë¡œë”©ì„ ê´€ë¦¬í•˜ê¸° ìœ„í•´ ì‚¬ìš©í•˜ë©°, ì‚¬ìš©ì ì •ì˜ Protocolì´ë‚˜ URL ìŠ¤í‚¤ë§ˆë¥¼ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ URLProtocolì„ ìƒì†í•œ í•˜ìœ„ í´ë˜ìŠ¤ë¥¼ ë§Œë“¤ì–´ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

URLSessionConfigurationë¥¼ ì´ìš©í•´ URLProtocolì„ ì§€ì •í•œ URLSessionì„ ë§Œë“¤ë©´, ë„¤íŠ¸ì›Œí‚¹ ì‘ì—…ì„ í•  ë•Œ ì§€ì •í•œ URLProtocolì´ ì‘ì—…ì˜ ì™„ë£Œ ì²˜ë¦¬ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Networking Test

URLProtocolì€ ì§€ì •ëœ URLSessionì˜ ë„¤íŠ¸ì›Œí‚¹ ì‘ì—…ì„ ëŒ€ì‹  ì²˜ë¦¬í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— í…ŒìŠ¤íŠ¸ì—ì„œ ë§ì´ ì‚¬ìš©ë©ë‹ˆë‹¤.

ê°„ë‹¨í•œ MockURLProtocol ê°ì²´ë¥¼ ë§Œë“¤ì–´ ë„¤íŠ¸ì›Œí‚¹ í…ŒìŠ¤íŠ¸ë¥¼ í•´ë³´ê² ìŠµë‹ˆë‹¤.

requestHandlerë¥¼ ì„¤ì •í•˜ë©´ startLoadingìœ¼ë¡œ ë„¤íŠ¸ì›Œí‚¹ ì‘ì—…ì´ ì‹œì‘í–ˆì„ ë•Œ clientì— requestHandlerì˜ Responseì™€ Dataë¥¼ ë°˜í™˜í•˜ë„ë¡ í–ˆìŠµë‹ˆë‹¤.

```swift
final class MockURLProtocol:URLProtocol {
  
  static var requestHandler: ((URLRequest) -> (HTTPURLResponse, Data?, Error?))?
  
  override class func canInit(with request: URLRequest) -> Bool {
    return true
  }
  
  override class func canonicalRequest(for request: URLRequest) -> URLRequest {
    return request
  }
  
  override func startLoading() {
    guard let handler = MockURLProtocol.requestHandler else { return }
    
    let (response, data, error) = handler(request)
    
    if let data = data {
      client?.urlProtocol(self, didReceive: response, cacheStoragePolicy: .notAllowed)
      client?.urlProtocol(self, didLoad: data)
      client?.urlProtocolDidFinishLoading(self)
    } else {
      client?.urlProtocol(self, didFailWithError: error!)
    }
  }
  
  override func stopLoading() { }
}
```

í…ŒìŠ¤íŠ¸ ì‹œì—ëŠ” MockURLProtocolì˜ requestHandlerì— DummyResponseë¥¼ ë„£ì–´, MockURLProtocolì„ ì§€ì •í•œ urlSessionìœ¼ë¡œ ë„¤íŠ¸ì›Œí‚¹ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•˜ë©´ MockURLProtocolì˜ Responseì™€ Dataê°€ ë°˜í™˜ë˜ì–´ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
func networkingTest() {
    // given
    let expectation = XCTestExpectation(description: "Networking Test")
    var resultData: Data?
    
    MockURLProtocol.requestHandler = { DummyResponse($0) }
    let configuration = URLSessionConfiguration.ephemeral
    configuration.protocolClasses = [MockURLProtocol.self]
    let urlSession = URLSession(configuration: configuration)
    
    // when
    let networkManager = NetworkManager(urlSession: urlSession)
    networkManager.request(with: URL(string: "Test")!) { result in
        switch result {
        case .success(let string):
            resultData = string
            expectation.fulfill()
        case .failure(let error):
            XCTFail(error.localizedDescription)
        }
    }
    
    // then
    wait(for: [expectation], timeout: 1)
    XCTAssertNotNil(resultData)
}
```

---
## ì°¸ê³  ë§í¬
- [Apple Developer: URLSession](https://developer.apple.com/documentation/foundation/urlsession)
- [WWDC 2018: Testing Tips & Tricks](https://developer.apple.com/videos/play/wwdc2018/417/)
