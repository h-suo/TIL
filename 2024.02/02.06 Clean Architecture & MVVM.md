# Today I Learned ğŸ¤“

> 2024.02.06 (í™”)

## Clean Architecture & MVVM

ì„¤ê³„ë¥¼ ìœ„í•œ ì•„í‚¤í…ì²˜ íŒ¨í„´ì€ êµ‰ì¥íˆ ë§ì´ ì¡´ì¬í•©ë‹ˆë‹¤. ê·¸ë“¤ì€ ëª¨ë‘ ê´€ì‹¬ì‚¬ì˜ ë¶„ë¦¬ë¼ëŠ” ê°™ì€ ëª©ì ì„ ê°€ì§€ê³  ê³„ì¸µì„ ë‚˜ëˆ  ì†Œí”„íŠ¸ì›¨ì–´ë¥¼ ë¶„ë¦¬í•©ë‹ˆë‹¤.

ì•„í‚¤í…ì²˜ íŒ¨í„´ì€ ì ì–´ë„ í•˜ë‚˜ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ ë ˆì´ì–´ì™€ ì¸í„°í˜ì´ìŠ¤ ë ˆì´ì–´ê°€ ì¡´ì¬í•©ë‹ˆë‹¤. ê·¸ë“¤ì€ í”„ë ˆì„ì›Œí¬, UI, ì™¸ë¶€ ê¸°ëŠ¥ì— ë…ë¦½ì ì´ê³  í…ŒìŠ¤íŠ¸ì— ìš©ì´í•œ ì‹œìŠ¤í…œì„ ë§Œë“¤ë„ë¡ ë„ì™€ì¤ë‹ˆë‹¤.

ì˜¤ëŠ˜ì€ iOS ì†Œí”„íŠ¸ì›¨ì–´ ì—”ì§€ë‹ˆì–´ë§ì— ë§ì´ ì‚¬ìš©ë˜ëŠ” Clean Architectureì™€ MVVMì— ëŒ€í•´ ì‚´í´ë³´ê² ìŠµë‹ˆë‹¤.

<br>

## Clean Architecture Layer

<Img src = "https://github.com/h-suo/TIL/assets/109963294/94513d68-bdac-48a4-89a1-57cc1ddf3239" width = "600"/>

Clean ArchitectureëŠ” í¬ê²Œ Entity, UseCase, Interface Adapters, Frameworks and Drivers 4ê°œì˜ ê³„ì¸µìœ¼ë¡œ ë‚˜ëˆ ì ¸ ìˆìŠµë‹ˆë‹¤.

### Entity

EntityëŠ” ì†Œí”„íŠ¸ì›¨ì–´ ì „ì²´ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ì„ ìº¡ìŠí™” í•œ ë°ì´í„° êµ¬ì¡°ì…ë‹ˆë‹¤.

ë‹¤ë¥¸ LayerëŠ” Entityë¥¼ ì˜ì¡´í•˜ê³  ì‚¬ìš©í•  ìˆ˜ ìˆì§€ë§Œ EntityëŠ” ë‹¤ë¥¸ Layerì— ì˜ì¡´í•˜ì§€ ì•Šì•„, ì™¸ë¶€ì— ë³€ê²½ì— ì˜í–¥ì„ ë°›ì§€ ì•Šë„ë¡ ë…ë¦½ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

### UseCase

ì†Œí”„íŠ¸ì›¨ì–´ì˜ ë¹„ì¦ˆë‹ˆìŠ¤ ê·œì¹™ì„ í¬í•¨í•˜ê³  êµ¬í˜„í•œ ë ˆì´ì–´ì…ë‹ˆë‹¤.

ì‹œìŠ¤í…œì˜ ëª¨ë“  ì‚¬ìš© ì‚¬ë¡€ë¥¼ ìº¡ìŠí™”í•˜ê³  Entityì™€ Data Flowë¥¼ ì¡°ìœ¨í•˜ë©°, DB ë˜ëŠ” UI ë³€ê²½ì— ì˜í–¥ì„ ë°›ì§€ ì•Šë„ë¡ ë…ë¦½ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.

### Interface Adapters

Interface AdaptersëŠ” UseCase ë° Entityì˜ í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³€í™˜í•˜ê±°ë‚˜, DB ë° ì™¸ë¶€ ì„œë¹„ìŠ¤ í˜•ì‹ìœ¼ë¡œ ë°ì´í„°ë¥¼ ë³€í™˜í•˜ëŠ” Layerì…ë‹ˆë‹¤.

MVCì˜ Controller, View í˜¹ì€ MVVMì˜ ViewModelì´ Interface Adaptersì— í•´ë‹¹í•©ë‹ˆë‹¤.

### Frameworks and Drivers

ê°€ì¥ ë°”ê¹¥ìª½ LayerëŠ” ì¼ë°˜ì ìœ¼ë¡œ DB, API ë“±ê³¼ ê°™ì€ ì‹œìŠ¤í…œì— í•„ìš”í•œ ë„êµ¬ë¡œ êµ¬ì„±ë©ë‹ˆë‹¤. 

í•´ë‹¹ Layerì—ëŠ” ëª¨ë“  ì„¸ë¶€ ì‚¬í•­ì´ í¬í•¨ë©ë‹ˆë‹¤.

<br>

Clean Architectureì˜ LayerëŠ” ì ˆëŒ€ì ì¸ ê²ƒì€ ì•„ë‹ˆë©° í•„ìš”í•˜ë‹¤ê³  ìƒê°ë˜ëŠ” ê³„ì¸µì€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. í•˜ì§€ë§Œ ì˜ì¡´ì„± ê·œì¹™ì€ í•­ìƒ Layerì˜ ë‚´ë¶€ë¡œë§Œ í–¥í•´ì•¼ í•˜ë©°, ì¶”ìƒí™” ìˆ˜ì¤€ ë˜í•œ ì¦ê°€í•˜ë„ë¡ í•´ì•¼ í•©ë‹ˆë‹¤.

ì´ëŸ¬í•œ ê°„ë‹¨í•œ ê·œì¹™ì„ ì¤€ìˆ˜í•˜ê³  ê³„ì¸µì„ ë‚˜ëˆ„ëŠ” ê²ƒë§Œìœ¼ë¡œ í…ŒìŠ¤íŠ¸ ê°€ëŠ¥í•˜ê³ , í™•ì¥ê³¼ ìˆ˜ì •ì— ìš©ì´í•œ ì‹œìŠ¤í…œì„ ë§Œë“¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

<br>

## in iOS

<Img src = "https://github.com/h-suo/TIL/assets/109963294/79909af3-9f1a-42f1-aa26-e7035646be7c" width = "800"/>

iOSì—ì„œëŠ” í¬ê²Œ Entityì™€ UseCaseë¥¼ ë¬¶ì–´ Domain, Presentation, Data 3ê°œì˜ ê³„ì¸µìœ¼ë¡œ ë‚˜ëˆ„ê²Œ ë©ë‹ˆë‹¤.

[ì˜ˆì‹œ í”„ë¡œì íŠ¸](https://github.com/h-suo/Diary)ë¥¼ ì´ìš©í•´ ê°„ë‹¨íˆ ê° Layerë¥¼ ì„¤ëª…í•˜ê² ìŠµë‹ˆë‹¤.

### [Domain](https://github.com/h-suo/Diary/tree/main/Diary_SwiftUI_MVVM/Diary/Domain)

Domain LayerëŠ” Entityì™€ UseCase ë° Repository ì¸í„°í˜ì´ìŠ¤ê°€ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

<Img src = "https://github.com/h-suo/TIL/assets/109963294/2360cd99-ecb1-4c3c-a851-1350fe28e78b" width = "300"/>

<br>

<br>

UseCaseì—ëŠ” ì¶”ìƒí™”ëœ Repositoryë¥¼ ì´ìš©í•œ ì‹œìŠ¤í…œì˜ ëª¨ë“  ì‚¬ìš© ì‚¬ë¡€ê°€ ìº¡ìŠí™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```swift
struct DiaryUseCase {
  
  private var repository: DiaryRepository
}

extension DiaryUseCase: DiaryRepository {
  
  func diarys() throws -> [Diary] {
    try repository.diarys()
  }
  
  func update(_ diary: Diary) throws {
    try repository.update(diary)
  }
  
  func delete(_ diary: Diary) throws {
    try repository.delete(diary)
  }
}
```

### [Presentation](https://github.com/h-suo/Diary/tree/main/Diary_SwiftUI_MVVM/Diary/Presentation)

Persentation LayerëŠ” MVVM íŒ¨í„´ì„ ì ìš©í•˜ì—¬ êµ¬í˜„í•˜ì˜€ìœ¼ë©° Viewì™€ ViewModelì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

ViewModelì€ UseCaseë¥¼ ì´ìš©í•´ ê°€ì ¸ì˜¨ ë°ì´í„°ë¥¼ Viewì— ë§ëŠ” ë°ì´í„°ë¡œ ë³€í™˜í•˜ê±°ë‚˜, ì‚¬ìš©ìì—ê²Œ ë°›ì•„ì˜¨ ë°ì´í„°ë¥¼ Repositoryì— ë§ëŠ” ë°ì´í„°ë¡œ ë³€í™˜í•˜ì—¬ UseCaseì— ì „ë‹¬í•˜ëŠ” ì—­í• ì„ í•©ë‹ˆë‹¤.

```swift
final class DiaryListViewModel: ObservableObject {
  
  @Published var diarys: [Diary] = []
  @Published var isError: Bool = false
  
  private(set) var errorMessage: String = String.empty
  
  private var useCase: DiaryUseCase
  
  init(useCase: DiaryUseCase) {
    self.useCase = useCase
  }
  
  func fetchDiarys() {
    do {
      self.diarys = try useCase.diarys().sorted { $0.date > $1.date }
      fetchWeatherIcon()
    } catch {
      print(error.localizedDescription)
      errorMessage = NameSpace.diaryFetchFailed
      isError = true
    }
  }
  
  func deleteDiary(_ diary: Diary) {
    do {
      try useCase.delete(diary)
      fetchDiarys()
    } catch {
      print(error.localizedDescription)
      errorMessage = NameSpace.diaryDeletionFailed
      isError = true
    }
  }
}
```

### [Data](https://github.com/h-suo/Diary/tree/main/Diary_SwiftUI_MVVM/Diary/Data)

DataëŠ” Domainì˜ Repository ì¸í„°í˜ì´ìŠ¤ë¥¼ ì‹¤ì²´í™”í•˜ì—¬ ì„¸ë¶€ êµ¬í˜„í•œ ê°ì²´ê°€ í¬í•¨ë©ë‹ˆë‹¤.

DiaryCoreDataRepositoryëŠ” Diaryë¥¼ ì €ì¥í•˜ëŠ” ê¸°ëŠ¥ì„ CoreDataë¥¼ ì´ìš©í•´ êµ¬í˜„í•œ ê°ì²´ì…ë‹ˆë‹¤.

```swift
struct DiaryCoreDataRepository {...}

extension DiaryCoreDataRepository: DiaryRepository {
  
  func diarys() throws -> [Diary] {
    let request = DiaryDTO.fetchRequest()
    
    do {
      let diaryEntitys = try context.fetch(request)
      return diaryEntitys.map {
        Diary(
          id: $0.id,
          title: $0.title,
          contents: $0.contents,
          date: $0.date,
          weatherID: $0.weatherID
        )
      }
    } catch {
      throw DiaryRepositoryError.fetch(error)
    }
  }
  
  func update(_ diary: Diary) throws {
    if let diaryDTO = try? fetchDiaryEntity(forId: diary.id) {
      diaryDTO.title = diary.title
      diaryDTO.contents = diary.contents
      diaryDTO.weatherID = diary.weatherID
    } else {
      let newDiaryDTO = DiaryDTO(context: context)
      newDiaryDTO.id = diary.id
      newDiaryDTO.title = diary.title
      newDiaryDTO.contents = diary.contents
      newDiaryDTO.date = diary.date
      newDiaryDTO.weatherID = diary.weatherID
    }
    
    do {
      try context.save()
    } catch {
      throw DiaryRepositoryError.update(error)
    }
  }
  
  func delete(_ diary: Diary) throws {
    guard let diaryEntity = try? fetchDiaryEntity(forId: diary.id)
    else { throw DiaryRepositoryError.fetchFailed }
    
    context.delete(diaryEntity)
    
    do {
      try context.save()
    } catch {
      throw DiaryRepositoryError.deletion(error)
    }
  }
}
```

---
## ì°¸ê³  ë§í¬
- [Blog: The Clean Architecture](https://blog.cleancoder.com/uncle-bob/2012/08/13/the-clean-architecture.html)
- [Medium: Clean Architecture and MVVM on iOS](https://tech.olx.com/clean-architecture-and-mvvm-on-ios-c9d167d9f5b3)
