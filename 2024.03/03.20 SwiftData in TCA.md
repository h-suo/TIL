# Today I Learned ğŸ¤“

> 2024.03.20 (ìˆ˜)

## SwiftData in TCA

SwiftDataë¥¼ TCAì—ì„œ ì‚¬ìš©í•˜ê¸° ìœ„í•´ DependencyKeyë¥¼ ì´ìš©í•´ ì˜ì¡´ì„±(Dependency) ë“±ë¡ì„ í•´ë³´ë„ë¡ í•˜ê² ìŠµë‹ˆë‹¤.

### Model

ìš°ì„  SwiftDataì— ì‚¬ìš©ë  Model ê°ì²´ë¥¼ ìƒì„±í•´ì•¼ í•©ë‹ˆë‹¤.

ê°„ë‹¨íˆ í•  ì¼ì„ ì €ì¥í•  TODO ê°ì²´ë¥¼ ìƒìƒí–ˆìŠµë‹ˆë‹¤.

```swift
@Model
final class TODO {
  @Attribute(.unique) var date: Date
  var title: String
  
  init(date: Date = Date(), title: String) {
    self.date = date
    self.title = title
  }
}
```

<br>

### DataBase

Modelì„ ì œì–´í•˜ê¸° ìœ„í•œ contextë¥¼ ìƒì„±í•´ ì£¼ëŠ” DataBase ê°ì²´ë¥¼ ìƒì„± ë° DependencyKeyë¡œ ì˜ì¡´ì„± ë“±ë¡ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.

í•„ìš”í•œ Modelì˜ Contextë¥¼ ë§Œë“¤ì–´ DataBaseì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ì€ë‹‰í™”í•©ë‹ˆë‹¤.

```swift
fileprivate let todoModelContext: ModelContext = {
  do {
    let container = try ModelContainer(for: TODO.self)
    return ModelContext(container)
  } catch {
    fatalError("Container creation failed.")
  }
}()
```

Database ê°ì²´ë¥¼ ë§Œë“¤ì–´ ì¸í„°í˜ì´ìŠ¤ë¥¼ ì •ì˜í•˜ê³  DependencyKeyë¥¼ ì±„íƒí•˜ê³  ì¸í„°í˜ì´ìŠ¤ì˜ ë™ì‘ì„ ì •ì˜í•©ë‹ˆë‹¤.

```swift
struct Database {
  var todoContext: () throws -> ModelContext
}

extension Database: DependencyKey {
  static let liveValue = Self(
    todoContext: { todoModelContext }
  )
}
```

DependencyValuesì— Database ê°ì²´ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.

```swift
extension DependencyValues {
  var database: Database {
    get { self[Database.self] }
    set { self[Database.self] = newValue }
  }
}
```

<br>

### TODO DataBase

TODO Model ê°ì²´ë¥¼ ì§ì ‘ ì €ì¥í•˜ê³  ì œì–´í•˜ê¸° ìœ„í•œ TODO DataBase ê°ì²´ë¥¼ ìƒì„± ë° DependencyKeyë¡œ ì˜ì¡´ì„± ë“±ë¡ì„ í•´ë³´ê² ìŠµë‹ˆë‹¤.

TODODataBaseë¥¼ ìƒì„± ë° ì¸í„°í˜ì´ìŠ¤ë¥¼ ì •ì˜í•©ë‹ˆë‹¤.

```swift
struct TODODatabase {
  var fetch: () throws -> [TODO]
  var add: (TODO) throws -> Void
  var delete: (TODO) throws -> Void
  
  enum DatabaseError: Error {
    case addFailed
    case deleteFailed
  }
}
```

DependencyKeyë¥¼ ì±„íƒí•˜ê³  ì¸í„°í˜ì´ìŠ¤ì˜ ë™ì‘ì„ ì •ì˜í•©ë‹ˆë‹¤.

database.contextë¥¼ ì´ìš©í•´ TODO Contextë¥¼ ë°›ì•„ì™€ contextë¥¼ ì´ìš©í•´ì„œ Model ê°€ì ¸ì˜¤ê¸°, ì¶”ê°€, ì‚­ì œë¥¼ êµ¬í˜„í•©ë‹ˆë‹¤.

```swift
extension TODODatabase: DependencyKey {
  static var liveValue: TODODatabase = Self(
    fetch: {
      do {
        @Dependency(\.database.todoContext) var context
        let todoContext = try context()
        let descriptor = FetchDescriptor<TODO>(sortBy: [SortDescriptor(\.date)])
        return try todoContext.fetch(descriptor)
      } catch {
        return []
      }
    },
    add: { todo in
      do {
        @Dependency(\.database.todoContext) var context
        let todoContext = try context()
        todoContext.insert(todo)
      } catch {
        throw DatabaseError.addFailed
      }
    },
    delete: { todo in
      do {
        @Dependency(\.database.todoContext) var context
        let todoContext = try context()
        todoContext.delete(todo)
      } catch {
        throw DatabaseError.deleteFailed
      }
    }
  )
}
```

DependencyValuesì— TODODatabase ê°ì²´ë¥¼ ë“±ë¡í•©ë‹ˆë‹¤.

```swift
extension DependencyValues {
  var todoDatabase: TODODatabase {
    get { self[TODODatabase.self] }
    set { self[TODODatabase.self] = newValue }
  }
}
```

---
## ì°¸ê³  ë§í¬
- [GitHub: SwiftDataTCA](https://github.com/SouzaRodrigo61/SwiftDataTCA)
