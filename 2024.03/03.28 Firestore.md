# Today I Learned ğŸ¤“

> 2024.03.28 (ëª©)

## Firestore

FirestoreëŠ” Firebase ë° Google Cloudì˜ ëª¨ë°”ì¼, ì›¹, ì„œë²„ ê°œë°œì— ì‚¬ìš©ë˜ëŠ” ìœ ì—°í•˜ê³  í™•ì¥ ê°€ëŠ¥í•œ ë°ì´í„°ë² ì´ìŠ¤ì…ë‹ˆë‹¤.

Firestoreë¥¼ ì´ìš©í•´ ê°„ë‹¨í•œ TODO ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” FirebaseDB ê°ì²´ë¥¼ ë§Œë“¤ì–´ ë³´ê² ìŠµë‹ˆë‹¤.

### Firestore ì´ˆê¸°í™”

Firestoreë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ ìš°ì„  Firebaseë¥¼ ì´ˆê¸°í™”í•´ì•¼ í•©ë‹ˆë‹¤.

FirebaseëŠ” ì•±ì´ launchingì´ ëë‚˜ì§€ ì§ì „ì— ì´ˆê¸°í™” ì‹œì¼œ Firebase ê¸°ëŠ¥ì„ ì•±ì—ì„œ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ í•©ë‹ˆë‹¤.

```swift
import FirebaseCore

final class AppDelegate: NSObject, UIApplicationDelegate {
  
  func application(
    _ application: UIApplication,
    didFinishLaunchingWithOptions launchOptions: [UIApplication.LaunchOptionsKey : Any]? = nil
  ) -> Bool {
    FirebaseApp.configure()
    return true
  }
}

@main
struct FirebaseTestProjectApp: App {
  
  @UIApplicationDelegateAdaptor(AppDelegate.self) var delegate
  
  var body: some Scene {
    WindowGroup {
      ContentView()
    }
  }
}
```

FirestoreëŠ” FirebaseDBì—ì„œ ì‚¬ìš©ë˜ê¸° ë•Œë¬¸ì— FirebaseDBê°€ ì´ˆê¸°í™”ë  ë•Œ ì´ˆê¸°í™” ì‹œì¼œì¤ë‹ˆë‹¤.

```swift
struct FirebaseDB {
  
  private let db: Firestore
  
  init(db: Firestore = Firestore.firestore()) {
    self.db = db
  }
}
```

<br>

### ë°ì´í„° êµ¬ì¡°í™”

Firestoreê³¼ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ì„ ë•Œ [String: Any] íƒ€ì… í˜¹ì€ Codable íƒ€ì…ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì£¼ê³ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

Codable íƒ€ì…ì„ ì‚¬ìš©í•˜ëŠ” ê²ƒì´ ì—ëŸ¬ ì²˜ë¦¬ì™€ TODO íƒ€ì… í™•ì¥ ì‹œ FirebaseDBë¥¼ ìˆ˜ì •í•˜ì§€ ì•Šì•„ë„ ë˜ê¸° ë•Œë¬¸ì— Codableì„ ì±„íƒí•˜ëŠ” ê²ƒìœ¼ë¡œ TODO ë°ì´í„°ë¥¼ êµ¬ì¡°í™”í–ˆìŠµë‹ˆë‹¤.

```swift
struct TODO: Codable {
  var id: String
  var title: String
  var body: String
  var deadline: Date
  
  init(
    id: String = UUID().uuidString,
    title: String,
    body: String,
    deadline: Date
  ) {
    self.id = id
    self.title = title
    self.body = body
    self.deadline = deadline
  }
}
```

<br>

### ë°ì´í„° ì½ê¸°

Firestoreì˜ getDocuments ë©”ì„œë“œë¡œ ì‰½ê²Œ ë°ì´í„°ë¥¼ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

TODOëŠ” Codableì„ ë”°ë¥´ê¸° ë•Œë¬¸ì— ê°€ì ¸ì˜¨ documents ë°ì´í„°ë¥¼ ì‰½ê²Œ ë””ì½”ë”© í•˜ì—¬ ë°˜í™˜í–ˆìŠµë‹ˆë‹¤.

```swift
func fetch() -> AnyPublisher<[TODO], FirebaseError> {
  return Future<[TODO], FirebaseError> { promise in
    db.collection("TODO").getDocuments { snapshot, error in
      if let error {
        promise(.failure(.fetchFailed(error.localizedDescription)))
      } else if let snapshot {
        let todos = snapshot.documents.compactMap { try? $0.data(as: TODO.self) }
        promise(.success(todos))
      }
    }
  }
  .eraseToAnyPublisher()
}
```

<br>

### ë°ì´í„° ì¶”ê°€

Firestoreì˜ setDataë¥¼ ì´ìš©í•´ ë°ì´í„°ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

addDoucmentë¡œ ë°ì´í„°ë¥¼ ì¶”ê°€í•  ìˆ˜ ìˆì§€ë§Œ Documentì˜ IDê°€ ìë™ í• ë‹¹ë˜ê¸° ë•Œë¬¸ì— setDataë¡œ Documentì˜ IDë¥¼ ì§€ì •í•´ ì¤Œê³¼ ë™ì‹œì— ë°ì´í„°ë¥¼ ì¶”ê°€ ë° ì—…ë°ì´íŠ¸ë¥¼ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```swift
func store(_ todo: TODO) -> AnyPublisher<TODO, FirebaseError> {
  return Future<TODO, FirebaseError> { promise in
    do {
      try db.collection("TODO").document(todo.id).setData(from: todo) { error in
        if let error {
          promise(.failure(.storeFailed(error.localizedDescription)))
        } else {
          promise(.success(todo))
        }
      }
    } catch {
      promise(.failure(.storeFailed("")))
    }
  }
  .eraseToAnyPublisher()
}
```

<br>

### ë°ì´í„° ì‚­ì œ

Firestoreì˜ deleteë¥¼ ì´ìš©í•´ ë°ì´í„°ë¥¼ ì‚­ì œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

deleteëŠ” Document IDë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì°¾ì•„ ì‚­ì œí•©ë‹ˆë‹¤.

```swift
func delete(_ todo: TODO) -> AnyPublisher<TODO, FirebaseError> {
  return Future<TODO, FirebaseError> { promise in
    db.collection("TODO").document(todo.id).delete { error in
      if let error {
        promise(.failure(.deleteFailed(error.localizedDescription)))
      } else {
        promise(.success(todo))
      }
    }
  }
  .eraseToAnyPublisher()
}
```

---
## ì°¸ê³  ë§í¬
- [Firebase Documents: Firestore](https://firebase.google.com/docs/firestore?hl=ko)
- [Firebase Documents: Firestore Quick Start](https://firebase.google.com/docs/firestore/quickstart?hl=ko)
